---
title: "Reviewing packages; how does it work?"
subtitle: "⚔<br/>xaringan with useR! template"
author: "Lluís Revilla"
institute: "IDIBAPS, CIBEREHD"
date: "2021/05/30 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: ["useR", "useR-fonts"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

# Brief introduction

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

ros <- readRDS("output/github_rOpenSci_data__cleaned.RDS")
cran <- readRDS("output/CRAN_data_cleaned.RDS")
bioc <- readRDS("output/submissions_bioconductor.RDS")

holidays <- data.frame(
  start = as.POSIXct("18/12/2020", format = "%d/%m/%Y", tz = "UTC"), 
  end = as.POSIXct("04/01/2021", format = "%d/%m/%Y", tz = "UTC")
)
library("tidyverse")
library("lubridate")
library("patchwork")
library("ggrepel")
theme_set(theme_minimal())

```

Goals of a *submission*

- Sharing something of quality that can be useful to others.
- Make it easier for others to build upon your package.
- Other: work, grant, prestige ...

--

.pull-left[
**Package reviews archives**

- CRAN

- Bioconductor

- rOpenSci

 ]
 
--

.pull-right[
**Objectives of the reviews?**

- Non-trivial publication quality packages.
- Promote high-quality, well documented and interoperable.
- Drive the adoption of best practices with useful, transparent and constructive feedback.
]


???

Differences in objectives but all looking for quality
CRAN: Point errors, comments
Bioconductor: In detail comment of style, classes, dependencies, structure…
rOpenSci: guideline for reviewers (about style, tests, functions, description, documentation, …)


CRAN ~16000 packages, Bioconductor ~2000,  rOpenSci ~300
To work with this slides use xaringan::infinite_moon_reader()

---

# Project differences

```{r echo=FALSE}
objective <- c("Publication quality and non-trivial",
               "High quality, well documented and interoperable",
               "Drive the adoption of best practices with useful, transparent and constructive feedback")
upload <- c("tar.gz file", "fill an issue", "fill an issue")
setup <- c("None", "ssh key, subscribe to mailing list", "Setup CI tests")
checks <- c("check --as-cran", "check; Biocheck", "check --as-cran")
os <- rep("Windows, Unix, iOS", 3)
R_versions <- c("oldrel, release, patched, devel", "release, devel", "oldrel, release, devel")
cycle <- c("Always open", "2 annual releases", "Always open")
review_system <- c("email & ftp", "Github", "Github")
editors <- c("?", "0", "~10")
reviewers <- c("?", "~10", "Volunteers")
df <- data.frame(Objective = objective, Submit = upload,
                 Setup = setup, Checks = checks, OS = os,
                 Cycle = cycle,
                 Versions = R_versions, 
                 Review = review_system,
                 Editors = editors,
                 Reviewers = reviewers)
rownames(df) <- c("CRAN", "Bioconductor", "rOpenSci")
knitr::kable(t(df)[-1, ], otuput = "html")
```

???

The different projects/archives have different setups.
Will use data from the three projects

---

# Submissions


```{r submissions, echo=FALSE, message=FALSE}

ros_submissions <- ros %>% 
  ungroup() %>% 
  filter(event == "created") %>% 
  mutate(presubmission = grepl("[Pp]re-?[Ss]ubmiss", title)) %>% 
  filter(!presubmission) %>% 
  mutate(month_year = format(created, "%Y-%m")) %>% 
  group_by(month_year) %>% 
  count() %>% 
  ggplot() +
  geom_col(aes(month_year, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "rOpenSci")
cran_submissions <- cran %>% 
  filter(folder == "newbies") %>% 
  distinct(package, .keep_all = TRUE) %>% 
  mutate(month_year = format(snapshot_time, "%Y-%m")) %>% 
  group_by(month_year) %>% 
  count() %>% 
  ggplot() +
  geom_col(aes(month_year, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "CRAN")
bioc_submission <- bioc %>% 
  filter(event == "created") %>% 
  mutate(month_year = format(as.Date(created), "%Y-%m")) %>% 
  group_by(month_year) %>% 
  count() %>% 
  ggplot() +
  geom_col(aes(month_year, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Bioconductor")
cran_submissions + bioc_submission + ros_submissions & 
  theme(axis.text.x = element_text(angle = 45, vjust = 1.5, 
                                   hjust = 1),
        panel.grid.major.x = element_blank())
```

???

Submissions monthly

---
# By folder

```{r cran-holidays, show=FALSE}
man_colors <- RColorBrewer::brewer.pal(8, "Dark2")
names(man_colors) <- unique(cran$folder)
cran %>% 
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package), .groups = "drop") %>% 
  ggplot() +
  geom_rect(data = holidays, aes(xmin = start, xmax = end, ymin = 0, ymax = 200),
            alpha = 0.25, fill = "red") +
  annotate("text", x = holidays$start + (holidays$end - holidays$start)/2, 
           y = 105, label = "CRAN holidays") +
  geom_path(aes(snapshot_time, packages, col = folder, linetype = folder)) +
  scale_x_datetime(date_labels = "%Y/%m/%d", date_breaks = "2 weeks", 
                   expand = expansion()) +
  scale_y_continuous(expand = expansion()) +
  scale_color_manual(values = man_colors) +
  labs(x = element_blank(), y = element_blank(),
       title = "Packages by folder", col = "Folder", linetype = "Folder") +
  theme(legend.position = c(0.6, 0.7))
```

???

Newbies is where most effort goes/hareder
Pretest is resubmission (newer versions of packages) and also for newbies

---


# Holidays effect

```{r cran-holidays-zoom}
cran %>% 
  filter(snapshot_time >= holidays$start,
         snapshot_time <= as.Date("2021/03/07")) %>% 
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package)) %>% 
  ggplot() +
  geom_path(aes(snapshot_time, packages, col = folder, linetype = folder)) +
  geom_rect(data = holidays, aes(xmin = start, xmax = end, ymin = 0, ymax = 200),
            alpha = 0.25, fill = "red") +
  annotate("text", x = holidays$start + (holidays$end - holidays$start)/2, 
           y = 105, label = "CRAN holidays") +
  scale_x_datetime(date_labels = "%m/%d", date_breaks = "1 week", 
                   expand = expansion()) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA)) +
  scale_color_manual(values = man_colors) +
  labs(x = element_blank(), y = element_blank(),
       title = "Holidays zoom", col = "Folder", linetype = "Folder") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.8, 0.7))
```


???
 
 2 months to get back to normal
 First served are the resubmissions of packages
 
 
---
# CRAN patterns


```{r cran-day-month}
cran_times <- cran %>% 
  mutate(date = as_date(snapshot_time),
         week = week(snapshot_time),
         mday = mday(snapshot_time),
         wday = wday(snapshot_time, locale = "en_GB.UTF-8"))
cran_dmonth <- cran_times %>% 
  arrange(folder, date, mday) %>% 
  filter(snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(folder, date, mday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, mday) %>% 
  ggplot() +
  geom_smooth(aes(mday, packages, col = folder, linetype = folder)) +
  labs(x = "Day of the month", y = "Packages", col = "Folder", linetype = "Folder",
       title = "Evolution by month day") +
  scale_color_manual(values = man_colors) +
  coord_cartesian(ylim = c(0, NA), xlim = c(1, NA)) +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion()) 

cran_dweek <- cran_times %>% 
  filter(snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(folder, date, wday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, wday) %>% 
  ggplot() +
  geom_smooth(aes(wday, packages, col = folder, linetype = folder)) +
  labs(x = "Day of the week", y = "Packages", col = "Folder", linetype = "Folder",
       title = "Evolution by week day") +
  scale_color_manual(values = man_colors) +
  scale_x_continuous(breaks = 1:7, expand = expansion()) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA))

cran_dmonth + cran_dweek + plot_layout(guides = 'collect') &
  guides(colour = guide_legend(nrow = 1, override.aes = list(fill = NA))) &
  theme(legend.position = "bottom")
```


---

# Review time

```{r cran-review}
submission_folders <- cran_times %>%
  group_by(package, resubmission_n, submission_n) %>% 
  count(folder) %>% 
  pivot_wider(names_from = folder, values_from = n, values_fill = 0) %>% 
  ungroup()

submission_folders_total <- cran_times %>%
  group_by(package, resubmission_n, submission_n) %>% 
  count(folder) %>% 
  summarize(h = sum(n)) %>% 
  ungroup()
submissions_times <- cran_times %>% 
  group_by(package, resubmission_n, submission_n) %>% 
  summarize(start = min(snapshot_time), end = max(snapshot_time),
            .groups = "drop") 
rsubm <- full_join(submission_folders, submission_folders_total) %>% 
  full_join(submissions_times)

p1 <- rsubm %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(title = "Time on the ftp site:", x = "Hours", 
       y = element_blank()) +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion())
p2 <- rsubm %>% 
  filter(h <= 24*7) %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(subtitle = "Zoom", x = "Hours", y = element_blank()) +
  scale_x_continuous(expand = expansion(), breaks = seq(0, 24*7, by = 24)) +
  scale_y_continuous(expand = expansion()) +
  theme(panel.background = element_rect(colour = "white"))
presubm <- p1 + inset_element(p2, 0.2, 0.2, 1, 1)

p1 <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarise(h = sum(h), .groups = "drop") %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(title = "Time on the ftp site:", x = "Hours", 
       y = element_blank()) +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion())
p2 <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarise(h = sum(h), .groups = "drop") %>% 
  filter(h <= 24*7) %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(subtitle = "Zoom", x = "Hours", y = element_blank()) +
  scale_x_continuous(expand = expansion(), breaks = seq(0, 24*7, by = 24)) +
  scale_y_continuous(expand = expansion()) +
  theme(panel.background = element_rect(colour = "white"))
p1 + inset_element(p2, 0.2, 0.2, 1, 1)
```


```{r submission_qc, eval=FALSE, include=FALSE}
# Quality check
rsubm %>% mutate(difff = time-h) %>% select(package, submission_n, time, h, difff) %>% arrange(-difff)
cran_times %>% filter(package == "rmt") %>% View("rmt") # Same version but several months appart! different submission
ggplot(rsubm) +
  geom_count(aes(time, h))
cran_times %>% 
  select(submission_n, resubmission_n, package) %>% 
  distinct() %>% 
  group_by(submission_n, resubmission_n) %>%
  count() %>% 
  ggplot() + 
  geom_point(aes(submission_n, resubmission_n, size = n))
# Why there are some gaps on same submission_n but 
cran_times %>% 
  select(submission_n, resubmission_n, package) %>% 
  distinct() %>% 
  group_by(package, submission_n) %>%
  summarize(n = max(resubmission_n) - min(resubmission_n) + 1) %>% 
  ungroup() %>% 
  group_by(submission_n) %>% 
  count(n) %>% 
  ungroup() %>% 
  ggplot() + 
  geom_point(aes(submission_n, n, size = nn))
# Why there are some gaps on same submission_n but 
```

???

Median time on submissions ~15 hours `r median(rsubm$time)`, mean time ~90 `r mean(rsubm$time)`
Between 2 and 81 hours (quartiles)

---

# CRAN submission time

```{r cran-submission-time}
subm_time <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarize(d = as.Date(min(start)),
         new = ifelse(any(newbies != 0), "New", "Update"),
         h = sum(h), .groups = "drop") %>%
  group_by(d, new) %>% 
  summarize(m = median(h),
            n = n()) %>% 
  filter(d < holidays$start | d > holidays$end)
subm_time %>% 
  ggplot() +
  geom_rect(data = holidays, 
            aes(xmin = as.Date(start), xmax = as.Date(end)),
            ymin = 0, ymax = 250, alpha = 0.5, fill = "red") + 
  geom_smooth(aes(d, m, col = new, size = n), span = 0.5) +
  geom_hline(aes(yintercept = time, col = new), data = . %>% group_by(new) %>% summarise(time = median(m), .groups = "drop"),
             linetype = "dashed", alpha = 0.5) +
  coord_cartesian(ylim = c(0, NA)) +
  labs(x = "Submission", y = "Daily median time in queue (hours)", 
       title = "Submission time", col = "Submission")

rsubm %>% 
    group_by(package, submission_n) %>% 
    summarize(d = as.Date(min(start)),
              new = ifelse(any(newbies != 0), "New", "Update"),
              h = sum(h), 
              across(newbies:recheck, .fns = sum, .names = "{.col}"))
```

```{r eval=FALSE, include=FALSE}
l <- lapply(unique(rsubm$package),
       function(x){
         y <- pkgsearch::cran_package_history(x)
         as_datetime(y$`Date/Publication`)})
```


???

New packages submissions are in ~81h, while resubmissions ~5h

```{r}
subm_time %>% 
  group_by(new) %>% 
  summarise(time = median(m), .groups = "drop")
```


use pkgsearch::cran_package_history("experDesign") for each package to know when a packages was added to CRAN. 

---

# Comments

How often do people comment and 

???


---

# Editors role

.pull-left[

```{r bioconductor-reviewers}
trelative <- function(x) {
  created <- x$created
  event <- x$event
  start <- created[event == "created"]
  k <- event == "closed"
  if (any(k)) {
    closing <- created[which.max(k)]
  } else {
    closing <- max(created)
  }
  
  o <- difftime(created[!is.na(created)], start, units = "days")
  as.numeric(o)
}

reviewers <- function(assigners, unassigners) {
  ta <- table(assigners)
  tu <- table(unassigners)
  y <- 0
  n <- sum(ta) - sum(tu)
  reviewers <- vector("character", n)
  for (reviwer in names(ta)) {
    x <- ta[reviwer] - tu[reviwer]
    if (x >= 1 | is.na(x)) {
      y <- y + 1
      reviewers[y] <- reviwer
    }
  }
  reviewers
}

bioc_by_issue <- bioc %>% 
  group_by(id) %>% 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            diff_events = n_distinct(event),
            Approved = unique(Approved),
            approved = unique(approved),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            unassigners = list(reviewer[event %in% "unassigned"]),
            reviewers = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            reviewer_comments = sum(event == "commented" & 
                                      actor %in% unlist(reviewers), na.rm = TRUE),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) %>% 
  mutate(n_reviewers = lengths(reviewers),
         n_closers = lengths(closer))

bioc_by_issue1 <- bioc %>% 
  group_by(id) %>% 
  count(event) %>% 
  filter(event != "created") %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>%
  nest_by(.key = "event")
bioc_by_issue2 <- bioc %>% 
  group_by(id) %>% 
  count(actor) %>% 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) %>% 
  nest_by(.key = "actor")

bioc_by_issue <- bioc_by_issue %>% 
  inner_join(bioc_by_issue1, by = "id") %>% 
  inner_join(bioc_by_issue2, by = "id")

bioc_by_user0 <- bioc %>%
  group_by(actor) %>% 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) %>% 
  mutate(is_reviewer = actor %in% unlist(bioc_by_issue$reviewers, FALSE, FALSE))

bioc_by_user1 <- bioc %>% 
  group_by(actor) %>% 
  count(event) %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
bioc_by_user2 <- bioc %>% 
  group_by(actor) %>% 
  count(id) %>% 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) %>% 
  nest_by(.key = "ids")

bioc_by_user <- bioc_by_user0 %>% 
  full_join(bioc_by_user1, by = "actor") %>% 
  full_join(bioc_by_user2, by = "actor")

bioc_by_user %>% 
  filter(is_reviewer) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_point(aes(issues_participated, actions)) +
  geom_text_repel(aes(issues_participated, actions, label = actor)) +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  labs(size = "Users", col = "Different events", y = "Actions", x = "Issues",
       title = "Reviewers involvement") +
  theme_minimal()
```

]

.pull-right[

```{r ropensci-editors}
ros_by_issue <- ros %>% 
  group_by(id) %>% 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            diff_events = n_distinct(event),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            unassigners = list(reviewer[event %in% "unassigned"]),
            editors = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            editor_comments = sum(event == "commented" & 
                                      actor %in% unlist(editors), na.rm = TRUE),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) %>% 
  mutate(n_reviewers = lengths(editors),
         n_closers = lengths(closer))

ros_by_issue1 <- ros %>% 
  count(event) %>% 
  filter(event != "created") %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
ros_by_issue2 <- ros %>% 
  count(actor) %>% 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) %>% 
  nest_by(.key = "actor")

ros_by_issue <- ros_by_issue %>% 
  inner_join(ros_by_issue1) %>% 
  inner_join(ros_by_issue2)

ros_by_user <- ros %>% 
  group_by(actor) %>% 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) %>% 
  mutate(is_editor = actor %in% unlist(ros_by_issue$editors, FALSE, FALSE))

ros_by_user1 <- ros %>% 
  group_by(actor) %>% 
  count(event) %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
ros_by_user2 <- ros %>% 
  group_by(actor) %>% 
  count(id) %>% 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) %>% 
  nest_by(.key = "ids")

ros_by_user <- ros_by_user %>% 
  inner_join(ros_by_user1) %>% 
  inner_join(ros_by_user2)


ros_editors <- ros_by_user %>% 
  filter(is_editor) %>% 
  distinct(actor) %>% 
  pull(actor)
ros_by_user %>% 
  filter(is_editor) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_point(aes(issues_participated, actions)) +
  geom_text_repel(aes(issues_participated, actions, label = actor)) +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  labs(size = "Users", col = "Different events", y = "Actions", x = "Issues",
       title = "Editors involvement") +
  theme_minimal()

```

]

???

Bioconductor reviewers do a lot
rOpenSci editors too

---

## Reviewers/Other people  role

.pull-left[

```{r users_commenters}
bioc_by_user %>% 
  filter(!is_reviewer & actor != "bioc-issue-bot" & !is.na(actor)) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_count(aes(issues_participated, actions)) +
  scale_color_viridis_d() + 
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  geom_text_repel(aes(issues_participated, actions, label = actor), 
                data = . %>% filter(issues_participated > 10 | actions > 100)) +
  labs(size = "Users", col = "Different events", y = "Actions", x = "Issues",
       title = "Bioconductor")
```

]

.pull-right[

```{r ros_comments}
ros_by_user %>% 
  filter(!is_editor & actor != "ropensci-review-bot" & !is.na(actor)) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_count(aes(issues_participated, actions)) +
  scale_color_viridis_d() + 
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  geom_text_repel(aes(issues_participated, actions, label = actor), 
                data = . %>% filter(issues_participated >= 10 | actions > 100)) +
  labs(size = "Users", col = "Different events", y = "Actions", x = "Issues",
       title = "rOpenSci")
```

]

???

Both organizations have a group of users involved on the package review system.
Even if Bioconductor doesn't explicitly ask for reviewers from the community.
Bioconductor are considering now how to improve the review system.
Omitted bots bioc-issue-bot and ropensci-review-bot (new March 2021).

---

## Bot role


```{r bioc-issue-bot}
comments <- bioc %>% 
  ungroup() %>% 
  filter(event == "commented")
bioc_bot <- comments %>% 
  filter(actor == "bioc-issue-bot") %>% 
  mutate(reason = case_when(
    startsWith(text, "Hi @") ~ "Received",
    startsWith(text, "Received a valid push") ~ "Valid push",
    str_detect(text, "^(\n)?Dear Package contributor,") ~ "Build result",
    startsWith(text, "A reviewer has been assigned to your package") ~ "Reviewer assigned",
    str_detect(text, "There is no repository called") ~ "Missing repository",
    str_detect(text, "Thanks for submitting your additional package") ~ "Additional package",
    str_detect(text, "has already posted ") ~ "repost",
    str_detect(text, "for an extended period of time") ~ "Closing",
    str_detect(text, "DESCRIPTION file") ~ "Unmatch",
    str_detect(text, "Your package has been approved for building") ~ "Building",
    str_detect(text, "We only start builds when the `Version`") ~ "Update version",
    str_detect(text, "fix your version number") ~ "Fix version",
    str_detect(text, "a GitHub repository URL") ~ "Missing repository",
    str_detect(text, "more than one GitHub URL") ~ "Multiple repositories",
    str_detect(text, "Add SSH keys") ~ "SSH key",
    startsWith(text, "Your package has been accepted.") ~ "Accepted",
    TRUE ~ "Other"
  ))
bioc_bot %>% 
  group_by(id) %>% 
  count(reason, sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_tile(aes(id, fct_reorder(reason, n, .fun = sum), col = n)) +
  scale_color_viridis_c(trans = "log10", expand = expansion()) +
  labs(x = "Issue", title = "bioc-issue-bot activity", 
       y = element_blank(), col = "Comments")
```

???

Bot provides feedback of many issues and actions performed. 
Change/adaption with time

---

# Bioc bot differences

```{r bioc-issue-bot-approved}
bioc_bot %>% 
  filter(Approved != "Ongoing") %>% 
  group_by(id, reason) %>% 
  summarize(n = n(), Approved = unique(Approved)) %>% 
  mutate(total = sum(n)) %>% 
  group_by(id) %>% 
  mutate(perc = n/total) %>% 
  filter(reason != "Accepted") %>% 
  group_by(reason) %>% 
  filter(n_distinct(Approved) >= 2) %>% 
  ungroup() %>% 
  filter(!reason %in% c("Unmatch", "Missing repository", "Building")) %>% 
  ggplot() +
  geom_jitter(aes(Approved, n, col = Approved, shape = Approved), height = 0) + 
  scale_y_continuous(limits = c(0, NA)) +
  facet_wrap(~reason, ncol = 4, scales = "free_y") +
  labs(x = element_blank(), y = "Comments", 
       title = "Diferences between accepted and non accepted issues by bioc-issue-bot comments")
```


---

# Timeline for submissions

CRAN: Not easy way to know

Bioconductor: 1 month

rOpenSci: around 2 months

???


rOpenSci: [Video](https://www.youtube.com/watch?v=iJnn_9xKkqk)

---

# Steps estimation time

---

