---
title: "Reviewing packages; how does it work?"
author: '[Lluís Revilla](https://llrs.dev) <br>
 [`r icons::fontawesome("square", "regular")`](https://user2021.llrs.dev) 
  [`r icons::fontawesome("github")`](https://github.com/llrs/) 
 [`r icons::fontawesome("twitter")`Lluis_Revilla](https://twitter.com/Lluis_Revilla) '
output:
  xaringan::moon_reader:
    css: ["useR", "useR-fonts"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

# Brief introduction

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align="center", fig.asp=0.618, fig.height=10, fig.retina=3)
# Change ratio of screen with
#   nature:
#      ratio: 9:1 
library("tidyverse")
library("lubridate")
library("patchwork")
library("ggrepel")
theme_set(theme_minimal())
# https://pkg.garrickadenbuie.com/xaringanExtra/#/slide-tone
xaringanExtra::use_slide_tone()
# Icons from: https://github.com/mitchelloharawild/icons
```


```{r metathis, echo=FALSE}
# https://www.garrickadenbuie.com/blog/sharing-xaringan-slides/
library(metathis)
meta() %>%
  meta_name("github-repo" = "llrs/user2021") %>% 
  meta_social(
    title = "Reviewing packages; how does it work?",
    description = paste(
      "Analysis and tips about how package reviews work.",
      "Presented at useR!2021."
    ),
    url = "https://user2021.llrs.dev",
    image = "https://llrs.dev/2020/07/bioconductor-submissions-reviews/index_files/figure-html/first_plot-1.png",
    image_alt = paste(
      "Image from a blog https://llrs.dev/2020/07/bioconductor-submissions-reviews/ for Reviewing packages; how does it work?", 
      "Horizontal axis the date, vertical axis the submissions on Bioconductor each point is an event on a submission. It shows a continuous increase on packages submitted.", 
      "Presented at useR!2021 by Lluís Revilla"
    ),
    og_type = "website",
    og_author = "Lluís Revilla",
    twitter_card_type = "summary",
    twitter_creator = "@Lluis_Revilla"
  )
```


```{r init, cache=TRUE}
ros <- readRDS("output/github_rOpenSci_data__cleaned.RDS")
cran <- readRDS("output/CRAN_data_cleaned.RDS")
bioc <- readRDS("output/submissions_bioconductor.RDS")

holidays <- data.frame(
  start = as.POSIXct("18/12/2020", format = "%d/%m/%Y", tz = "UTC"), 
  end = as.POSIXct("04/01/2021", format = "%d/%m/%Y", tz = "UTC")
)
```


Goals of a *submission*

- Sharing something of quality that can be useful to others.
- Make it easier for others to build upon your package.
- Other: work, grant, prestige ...

???

Submissions are though specially if coming from places with poor training
Lack of confidence/experience with reviews.

--

.pull-left[
**Archives reviewing packages**

- CRAN

- Bioconductor

- rOpenSci

 ]
 
--

.pull-right[
**Objectives of the reviews?**

- Non-trivial publication quality packages.
- Promote high-quality, well documented and interoperable.
- Drive the adoption of best practices with useful, transparent and constructive feedback.
]


???

Differences in objectives but all looking for quality
CRAN: Point errors, comments
Bioconductor: In detail comment of style, classes, dependencies, structure…
rOpenSci: guideline for reviewers (about style, tests, functions, description, documentation, …)


CRAN ~16000 packages, Bioconductor ~2000,  rOpenSci ~300
To work with this slides use xaringan::infinite_moon_reader()

---

# Project differences

```{r diff_proj, cache=TRUE}
objective <- c("Publication quality and non-trivial",
               "High quality, well documented and interoperable",
               "Drive the adoption of best practices with useful, transparent and constructive feedback")
upload <- c("tar.gz file", "fill an issue", "fill an issue")
setup <- c("None", "ssh key, subscribe mailing", "CI tests")
checks <- c("check --as-cran", "check; Biocheck", "check --as-cran")
os <- rep("Windows, Unix, iOS", 3)
R_versions <- c("oldrel, release, patched, devel", "release, devel", "oldrel, release, devel")
cycle <- c("Always open", "2 annual releases", "Always open")
editors <- c("0", "0", "~10")
reviewers <- c("~5", "~10", "Volunteers")
review_system <- c("email & ftp", "Github", "Github")
df <- data.frame(Objective = objective, Submit = upload,
                 Review = review_system,
                 Setup = setup, Checks = checks, OS = os,
                 Versions = R_versions, 
                 Cycle = cycle,
                 Editors = editors,
                 Reviewers = reviewers)
rownames(df) <- c("CRAN", "Bioconductor", "rOpenSci")
knitr::kable(t(df)[-1, ], otuput = "html")
```

[CRAN](https://cran.r-project.org/submit.html)  [Bioconductor](https://github.com/Bioconductor/Contributions/) 
[rOpenSci](https://github.com/ropensci/software-review/)

???

The different projects/archives have different setups.
*Read the table*
Will use data from the three projects but mostly refer to CRAN.
All of them first you need to pass the automatic checks in place before a human looks into it.

---

# Submissions


```{r submissions}
cran_submissions <- cran %>% 
  filter(folder == "newbies") %>% 
  distinct(package, .keep_all = TRUE) %>% 
  group_by(month = lubridate::floor_date(snapshot_time, "month")) %>%   count() %>% 
  ggplot() +
  geom_col(aes(month, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "CRAN")
bioc_submission <- bioc %>% 
  filter(event == "created") %>% 
  group_by(month = lubridate::floor_date(created, "month")) %>% 
  count() %>%
  ungroup() %>% 
  ggplot() +
  geom_col(aes(month, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Bioconductor")
ros_submissions <- ros %>% 
  ungroup() %>% 
  filter(event == "created") %>% 
  mutate(presubmission = grepl("[Pp]re-?[Ss]ubmiss", title)) %>% 
  filter(!presubmission) %>% 
  group_by(month = lubridate::floor_date(created, "month")) %>% 
  count() %>% 
  ungroup() %>% 
  ggplot() +
  geom_col(aes(month, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "rOpenSci")
cran_submissions + bioc_submission + ros_submissions & 
  scale_x_datetime(date_labels = "%y/%m", date_breaks = "4 months", 
                   expand = expansion()) &
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank())
```

CRAN data thanks to the [incoming dashboard](https://lockedata.github.io/cransays/articles/dashboard.html).

???

One order of magnitude of difference between each other CRAN > Bioconductor > rOpenSci
Many variability on month
Also very few data from CRAN 

---
# Organization

```{r cran-holidays, fig.height=5}
man_colors <- RColorBrewer::brewer.pal(8, "Dark2")
names(man_colors) <- unique(cran$folder)
cran %>% 
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package), .groups = "drop") %>% 
  filter(folder %in% c("newbies", "pretest")) %>%
  ggplot() +
  geom_rect(data = holidays, aes(xmin = start, xmax = end, ymin = 0, ymax = 200),
            alpha = 0.25, fill = "red") +
  annotate("text", x = holidays$start + (holidays$end - holidays$start)/2, 
           y = 125, label = "CRAN holidays") +
  geom_path(aes(snapshot_time, packages, col = folder, linetype = folder)) +
  scale_x_datetime(date_labels = "%m/%d", date_breaks = "2 weeks", 
                   expand = expansion()) +
  scale_y_continuous(expand = expansion()) +
  scale_color_manual(values = man_colors) +
  labs(x = element_blank(), y = element_blank(),
       title = "Packages by folder", col = "Folder", linetype = "Folder") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.6, 0.7))
```

Packages are moved by reviewers between folders.

???

Many folders but these two are the most important.
There isn't an explanation from CRAN about how do they work.
Pretest is resubmission (newer versions of packages) and also for newbies

---


# Workload after holidays

```{r cran-holidays-zoom}
cran %>% 
  filter(snapshot_time >= holidays$end,
         folder %in% c("newbies", "pretest")) %>%
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package)) %>% 
  ggplot() +
  geom_path(aes(snapshot_time, packages, col = folder, linetype = folder)) +
  scale_x_datetime(date_labels = "%m/%d", date_breaks = "1 week", 
                   expand = expansion()) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA)) +
  scale_color_manual(values = man_colors) +
  labs(x = element_blank(), y = element_blank(),
       title = "Holidays zoom", col = "Folder", linetype = "Folder") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.8, 0.7))
```

Big volume of work! Patience!

???
 
2 months to get back to normal for new packages.
First served are the resubmissions of packages.
 
---

# Submissions patterns

```{r cran-day-month}
cran_times <- cran %>% 
  mutate(date = as_date(snapshot_time),
         week = week(snapshot_time),
         mday = mday(snapshot_time),
         wday = wday(snapshot_time, locale = "en_GB.UTF-8"))
cran_dmonth <- cran_times %>% 
  filter(folder %in% c("newbies", "pretest"),
         snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  arrange(folder, date, mday) %>% 
  group_by(folder, date, mday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, mday) %>% 
  ggplot() +
  geom_smooth(aes(mday, packages, col = folder, linetype = folder)) +
  labs(x = "Day of the month", y = "Packages", col = "Folder", linetype = "Folder",
       title = "Evolution by month day") +
  scale_color_manual(values = man_colors) +
  coord_cartesian(ylim = c(0, NA), xlim = c(1, NA)) +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion()) 

cran_dweek <- cran_times %>% 
  filter(folder %in% c("newbies", "pretest"),
         snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(folder, date, wday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, wday) %>% 
  ggplot() +
  geom_smooth(aes(wday, packages, col = folder, linetype = folder)) +
  labs(x = "Day of the week", y = "Packages", col = "Folder", linetype = "Folder",
       title = "Evolution by week day") +
  scale_color_manual(values = man_colors) +
  scale_x_continuous(breaks = 1:7, expand = expansion()) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA))

cran_dmonth + cran_dweek + plot_layout(guides = 'collect') &
  guides(colour = guide_legend(nrow = 1, override.aes = list(fill = NA))) &
  theme(legend.position = "bottom")
```

Check [dashboard](https://lockedata.github.io/cransays/articles/dashboard.html) before submitting?

???

Submit when you are ready, better be on the queue than outside.

---

# Review time

```{r cran-review}
submission_folders <- cran_times %>%
  filter(snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(package, resubmission_n, submission_n) %>% 
  count(folder) %>% 
  pivot_wider(names_from = folder, values_from = n, values_fill = 0) %>% 
  ungroup()

submission_folders_total <- cran_times %>%
  filter(snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(package, resubmission_n, submission_n) %>% 
  count(folder) %>% 
  summarize(h = sum(n)) %>% 
  ungroup()
submissions_times <- cran_times %>% 
  filter(snapshot_time < holidays$start | snapshot_time  > holidays$end) %>% 
  group_by(package, resubmission_n, submission_n) %>% 
  summarize(start = min(snapshot_time), end = max(snapshot_time),
            .groups = "drop") 
rsubm <- full_join(submission_folders, submission_folders_total) %>% 
  full_join(submissions_times)

p1 <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarise(h = sum(h), .groups = "drop") %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(title = element_blank(), x = "Hours", 
       y = "Submissions") +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion())
p2 <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarise(h = sum(h), .groups = "drop") %>% 
  filter(h <= 24*7) %>% 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24, boundary = 0.5) +
  labs(subtitle = "Zoom", x = "Hours", y =  "Submissions") +
  scale_x_continuous(expand = expansion(), breaks = seq(24, 24*8, by = 24)) +
  scale_y_continuous(expand = expansion()) +
  theme(panel.background = element_rect(colour = "white"),
        panel.grid.minor.x = element_blank())
p1 + inset_element(p2, 0.2, 0.2, 1, 1)
```

Reviews are short, brief and to the point.

???

Median time on submissions ~`r median(rsubm$time, na.rm = TRUE)` hours, mean time ~`r mean(rsubm$time, na.rm = TRUE)` hours.
Between 2 and 81 hours (quartiles)

---

# Review speed 

```{r cran-submission-time}
subm_time <- rsubm %>% 
  group_by(package, submission_n) %>% 
  summarize(d = as.Date(min(start)),
         new = ifelse(any(newbies != 0), "New", "Update"),
         h = sum(h), .groups = "drop") %>%
  group_by(d, new) %>% 
  summarize(m = median(h),
            n = n()) %>% 
  filter(d < holidays$start | d > holidays$end)
subm_time %>% 
  ggplot() +
  geom_rect(data = holidays, 
            aes(xmin = as.Date(start), xmax = as.Date(end)),
            ymin = 0, ymax = 250, alpha = 0.5, fill = "red") + 
  annotate("text", x = as.Date(holidays$start + (holidays$end - holidays$start)/2),
  y = 150, label = "CRAN holidays") +
  geom_smooth(aes(d, m, col = new, size = n), span = 0.5) +
  scale_x_date(date_labels = "%m/%d", date_breaks = "1 month", 
                   expand = expansion()) +
  geom_hline(aes(yintercept = time, col = new), data = . %>% group_by(new) %>% summarise(time = median(m), .groups = "drop"),
             linetype = "dashed", alpha = 0.5) +
  coord_cartesian(ylim = c(0, NA)) +
  scale_color_viridis_d() +
  labs(x = "Submission date", y = "Hours", 
       title = element_blank(), col = "Submission") +
  theme(legend.position = c(0.8, 0.7))
```

Expect 3-7 days till your new package is on CRAN.

???

Different time, can be shorter or longer.
Most longer need resubmission.
Resubmit with different version (makes it easier to track how many are).

```{r subm_time}
subm_time %>% 
  group_by(new) %>% 
  summarise(time = median(m), .groups = "drop")
```



```{r by_issue}
trelative <- function(x) {
  created <- x$created
  event <- x$event
  start <- created[event == "created"]
  k <- event == "closed"
  if (any(k)) {
    closing <- created[max(which(k))]
  } else {
    closing <- max(created)
  }
  
  o <- difftime(created[!is.na(created)], start, units = "days")
  as.numeric(o)
}

reviewers <- function(assigners, unassigners) {
  ta <- table(assigners)
  tu <- table(unassigners)
  y <- 0
  n <- sum(ta) - sum(tu)
  reviewers <- vector("character", n)
  for (reviwer in names(ta)) {
    x <- ta[reviwer] - tu[reviwer]
    if (x >= 1 | is.na(x)) {
      y <- y + 1
      reviewers[y] <- reviwer
    }
  }
  reviewers
}

bioc_by_issue <- bioc %>% 
  group_by(id) %>% 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            diff_events = n_distinct(event),
            Approved = unique(Approved),
            approved = unique(approved),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            author = actor[event == "created"],
            last_closed = ifelse(any(event == "closed"), max(created[which(event == "closed")]), max(created)),
            unassigners = list(reviewer[event %in% "unassigned"]),
            reviewers = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            reviewer_comments = sum(event == "commented" & 
                                      actor %in% unlist(reviewers) & created < last_closed, na.rm = TRUE),
            comments = sum(event == "commented" & created < last_closed),
            bot_comments = sum(event == "commented" & actor == "bioc-issue-bot" & created < last_closed),
            author_comments = sum(event == "commented" & actor == author& created < last_closed),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) %>% 
  mutate(n_reviewers = lengths(reviewers),
         n_closers = lengths(closer))

bioc_by_issue1 <- bioc %>% 
  group_by(id) %>% 
  count(event) %>% 
  filter(event != "created") %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>%
  nest_by(.key = "event")
bioc_by_issue2 <- bioc %>% 
  group_by(id) %>% 
  count(actor) %>% 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) %>% 
  nest_by(.key = "actor")

bioc_by_issue <- bioc_by_issue %>% 
  inner_join(bioc_by_issue1, by = "id") %>% 
  inner_join(bioc_by_issue2, by = "id")


ros_by_issue <- ros %>% 
  group_by(id) %>% 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            author = actor[event == "created"],
            diff_events = n_distinct(event),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            unassigners = list(reviewer[event %in% "unassigned"]),
            last_closed = ifelse(any(event == "closed"), max(created[which(event == "closed")]), max(created)),
            editors = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            editor_comments = sum(event == "commented" & 
                                      actor %in% unlist(editors) & created < last_closed, na.rm = TRUE),
            comments = sum(event == "commented" & created < last_closed),
            bot_comments = sum(event == "commented" & actor == "ropensci-review-bot" & created < last_closed),
            author_comments = sum(event == "commented" & actor == author & created < last_closed),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) %>% 
  mutate(n_reviewers = lengths(editors),
         n_closers = lengths(closer))

ros_by_issue1 <- ros %>% 
  count(event) %>% 
  filter(event != "created") %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
ros_by_issue2 <- ros %>% 
  count(actor) %>% 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) %>% 
  nest_by(.key = "actor")

ros_by_issue <- ros_by_issue %>% 
  inner_join(ros_by_issue1) %>% 
  inner_join(ros_by_issue2)

```


---

# Users role

```{r bioconductor-reviewers}
bioc_by_user0 <- bioc %>%
  group_by(actor) %>% 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) %>% 
  mutate(is_reviewer = actor %in% unlist(bioc_by_issue$reviewers, FALSE, FALSE))

bioc_by_user1 <- bioc %>% 
  group_by(actor) %>% 
  count(event) %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
bioc_by_user2 <- bioc %>% 
  group_by(actor) %>% 
  count(id) %>% 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) %>% 
  nest_by(.key = "ids")

bioc_by_user <- bioc_by_user0 %>% 
  full_join(bioc_by_user1, by = "actor") %>% 
  full_join(bioc_by_user2, by = "actor")

bioc_users_plot <- bioc_by_user %>% 
  filter(actor != "bioc-issue-bot" & !is.na(actor)) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_count(aes(issues_participated, actions, col = is_reviewer, shape = is_reviewer)) +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  labs(size = "Users", col = "Reviewer?", y = "Actions", 
       x = "Issues", shape = "Reviewer?",
       title = "Users involvement") +
  theme_minimal()
```

```{r ropensci-editors}
ros_by_user <- ros %>% 
  group_by(actor) %>% 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) %>% 
  mutate(is_editor = actor %in% unlist(ros_by_issue$editors, FALSE, FALSE))

ros_by_user1 <- ros %>% 
  group_by(actor) %>% 
  count(event) %>% 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) %>% 
  nest_by(.key = "event")
ros_by_user2 <- ros %>% 
  group_by(actor) %>% 
  count(id) %>% 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) %>% 
  nest_by(.key = "ids")

ros_by_user <- ros_by_user %>% 
  inner_join(ros_by_user1) %>% 
  inner_join(ros_by_user2)


ros_editors <- ros_by_user %>% 
  filter(is_editor) %>% 
  distinct(actor) %>% 
  pull(actor)
ros_users_plot <- ros_by_user %>% 
  filter(actor != "ropensci-reviewer-bot" & !is.na(actor)) %>%
  unnest(event) %>% 
  filter(commented != 0) %>% 
  ggplot() + 
  geom_count(aes(issues_participated, actions, col = is_editor, shape = is_editor)) +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  labs(size = "Users", col = "Different events", y = "Actions", x = "Issues",
       title = "rOpenSci") +
  theme_minimal()

```


```{r users-plots}
(bioc_users_plot + ros_users_plot &
   guides(col = FALSE, shape = FALSE) &
   scale_color_viridis_d() &
   scale_y_continuous(limits = c(1, 10000), trans = "log10") &
   scale_size(limits = c(1, 40))) +
  plot_layout(guides = "collect")
```

Some users help with many reviews.

???

Bioconductor reviewers do a lot
rOpenSci editors too
Both organizations have a group of users involved on the package review system.
Even if Bioconductor doesn't explicitly ask for reviewers from the community.
Bioconductor are considering now how to improve the review system.
Omitted bots bioc-issue-bot and ropensci-review-bot (new March 2021).

---

# Comments

```{r comments, cache = TRUE}
bioc_author_reviewer_comments <- bioc_by_issue %>% 
  select(id, Approved, comments, 
         reviewer_comments, author_comments, bot_comments) %>% 
  filter(Approved != "Ongoing") %>% 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") %>% 
  filter(!(author_comments == 0 & reviewer_comments == 0)) %>% 
  ggplot() +
  geom_count(aes(author_comments, reviewer_comments)) +
  labs(size = "Issues", x = "Authors", y = "Reviwers", title = element_blank())

bioc_auth_other_comments <- bioc_by_issue %>% 
  select(id, comments, 
         reviewer_comments, author_comments, bot_comments) %>% 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") %>% 
  filter(!(author_comments == 0 & reviewer_comments == 0)) %>% 
  ggplot() +
  geom_count(aes(author_comments, comments - reviewer_comments - bot_comments - author_comments)) +
  labs(size = "Issues", x = "Authors", y = "Other", title = element_blank())

ros_author_editor_comments <- ros_by_issue %>% 
  select(id, comments, 
         editor_comments, author_comments, bot_comments) %>% 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") %>% 
  filter(!(author_comments == 0 & editor_comments == 0)) %>% 
  ggplot() +
  geom_count(aes(author_comments, editor_comments)) +
  labs(size = "Issues", x = "Authors", y = "Editors", title = element_blank())

ros_auth_other_comments <- ros_by_issue %>% 
  select(id, comments, 
         editor_comments, author_comments, bot_comments) %>% 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") %>% 
  filter(!(author_comments == 0 & editor_comments == 0)) %>% 
  ggplot() +
  geom_count(aes(author_comments, comments - editor_comments - bot_comments - author_comments)) +
  labs(size = "Issues", x = "Authors", y = "Reviewers & other", title = element_blank())

((bioc_author_reviewer_comments + ros_author_editor_comments) /
  ( bioc_auth_other_comments + ros_auth_other_comments) & 
    scale_size(limits = c(1, 60))) +
  plot_layout(guides = "collect")
```

A dialog between authors and reviewers & editors. 

???

Non reviewers users on bioconductor still chime in to help.

---

# Bot role

```{r bioc-issue-bot}
comments <- bioc %>% 
  ungroup() %>% 
  filter(event == "commented")
bioc_bot <- comments %>% 
  filter(actor == "bioc-issue-bot") %>% 
  mutate(reason = case_when(
    startsWith(text, "Hi @") ~ "Received",
    startsWith(text, "Received a valid push") ~ "Valid push",
    str_detect(text, "^(\n)?Dear Package contributor,") ~ "Build result",
    startsWith(text, "A reviewer has been assigned to your package") ~ "Reviewer assigned",
    str_detect(text, "There is no repository called") ~ "Missing repository",
    str_detect(text, "Thanks for submitting your additional package") ~ "Additional package",
    str_detect(text, "has already posted ") ~ "Repost",
    str_detect(text, "for an extended period of time") ~ "Closing",
    str_detect(text, "DESCRIPTION file") ~ "Unmatch",
    str_detect(text, "Your package has been approved for building") ~ "Building",
    str_detect(text, "We only start builds when the `Version`") ~ "Update version",
    str_detect(text, "fix your version number") ~ "Fix version",
    str_detect(text, "a GitHub repository URL") ~ "Missing repository",
    str_detect(text, "more than one GitHub URL") ~ "Multiple repositories",
    str_detect(text, "Add SSH keys") ~ "SSH key",
    startsWith(text, "Your package has been accepted.") ~ "Accepted",
    TRUE ~ "Other"
  ))
bioc_bot %>% 
  group_by(id) %>% 
  count(reason, sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_tile(aes(id, fct_reorder(reason, n, .fun = sum), col = n)) +
  scale_color_viridis_c(trans = "log10", expand = expansion()) +
  labs(x = "Issue", title = "bioc-issue-bot activity", 
       y = element_blank(), col = "Comments")
```

Bot helps on the process and changes with the process

???

Bot provides feedback of many issues and actions performed. 
It can be changed/adapted to change in requirements or errors.
rOpenSci is going to have a bot too [ropensci-review-bot](https://github.com/ropensci-review-bot/). 

---

# Labels

```{r labels}
bioc_labels <- bioc %>% 
  filter(event == "labeled") %>% 
  mutate(label = unlist(label),
         label = case_when(
           label == "1a. awaiting moderation" ~ "1. awaiting moderation", 
           label == "4a. accepted" ~ "3a. accepted",
           label == "ok_to_build" ~ "1. awaiting moderation",
           label == "awaiting moderation" ~ "1. awaiting moderation",
           label == "review-in-progress" ~ "2. review in progress",
           label == "TESTING" ~ NA_character_, 
           TRUE ~ label)) %>% 
  filter(!is.na(label))

bioc_ord_label <- c("1. awaiting moderation",  
               "2. review in progress", "3a. accepted", 
               "3b. declined", "3c. inactive")
bioc_labels_plot <- bioc_labels %>% 
  filter(label %in% bioc_ord_label) %>% 
  group_by(id) %>% 
  count(label, sort = TRUE) %>% 
  ggplot() +
  geom_tile(aes(id, fct_relevel(label, rev(bioc_ord_label)), fill = n)) +
  scale_fill_continuous(trans = "log10") +
  labs(x = "Issue", y = element_blank(), title = "Labels per Issue",
       fill = "Times") +
  scale_fill_continuous(limits = c(1, 5))



ros_labels <- ros %>% 
  ungroup() %>% 
  filter(event == "labeled") %>% 
  mutate(label = unlist(label),
         label = case_when(
           label == "reviewer-requested" ~ "2/seeking-reviewer(s)",
           label == "seeking-reviewers" ~ "2/seeking-reviewer(s)",
           label == "2/seeking-reviewers" ~ "2/seeking-reviewer(s)",
           label == "3/reviewers-assigned" ~ "3/reviewer(s)-assigned",
           label == "4/review-in-awaiting-changes" ~ "4/review(s)-in-awaiting-changes",
           label == "review-in-awaiting-changes" ~ "4/review(s)-in-awaiting-changes",
           label == "changes-in-awaiting-response" ~ "4/review(s)-in-awaiting-changes",
           label == "5/awaiting-reviewer-response" ~ "5/awaiting-reviewer(s)-response",
           label == "approved" ~ "6/approved",
           label == "topic:linquistics" ~ "topic:linguistics",
           TRUE ~ label
         ))

ros_ord_label <- c("0/presubmission",
               "1/editor-checks",  
               "2/seeking-reviewer(s)", "3/reviewer(s)-assigned", 
               "4/review(s)-in-awaiting-changes",
               "5/awaiting-reviewer(s)-response", 
               "6/approved")
ros_labels_plot <- ros_labels %>% 
  group_by(id) %>% 
  count(label, sort = TRUE) %>% 
  ungroup() %>% 
  filter(label %in% ros_ord_label) %>% 
  ggplot() +
  geom_tile(aes(id, fct_relevel(label, rev(ros_ord_label)), fill = n)) +
  labs(x = "Issue", y = element_blank(), title = "Labels related to the review process",
       fill = "Times") +
  scale_fill_continuous(limits = c(1, 5))
bioc_labels_plot + ros_labels_plot + plot_layout(guides = "collect")
```

Labels are used to indicate progress on the submission.

???

On bioconductor most problems with the submissions are not the package itself but not replying or chosing another venue.
rOpenSci provides more detailed questioning for scope of a package.

---

# Success submissions

CRAN: Not easy way to know

Bioconductor: 1 month

rOpenSci: around 2 months


???

CRAN:
Bioconductor: most of them in 1 month
rOpenSci: in 2 months (seeking 2 reviwers and posting them).

```{r cran_success, eval=FALSE, include=FALSE}
l <- lapply(unique(rsubm$package),
       function(x){
         y <- pkgsearch::cran_package_history(x)
         as_datetime(y$`Date/Publication`)})
```

---

# Submit ?

- Prepare
  
  Follow policies and guidelines: [CRAN](https://cran.r-project.org/web/packages/policies.html), [Bioconductor](https://www.bioconductor.org/developers/package-submission/), [rOpenSci](https://devguide.ropensci.org/).

- **Fix**

- Resubmit

]

.center[

# Thanks

R core and CRAN team
Bioconductor core, 
rOpenSci editors and reviewers

]

.center[

.bottom[

***Questions ?***

]

]
???

rOpenSci review: [Video](https://www.youtube.com/watch?v=iJnn_9xKkqk)
